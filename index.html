<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sencillo v3.1</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            base: '#050505',    // Negro casi puro
                            surface: '#121212', // Gris muy oscuro para tarjetas
                            highlight: '#1E1E1E', // Para inputs/hovers
                        },
                        brand: {
                            light: '#6EE7B7', // Emerald 300
                            DEFAULT: '#10B981', // Emerald 500
                            dark: '#047857',    // Emerald 700
                        }
                    },
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    backgroundImage: {
                        'card-gradient': 'linear-gradient(135deg, #34D399 0%, #059669 100%)',
                        'app-bg': 'radial-gradient(circle at 50% 0%, #1e293b 0%, #050505 40%)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'bounce-in': 'bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        bounceIn: { '0%': { transform: 'scale(0)' }, '70%': { transform: 'scale(1.1)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    
    <!-- Fuente Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: none; 
            font-family: 'Outfit', sans-serif; 
            background-color: #050505;
            color: #ffffff;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Estilos P&L Oscuro Mejorado */
        .pnl-table-container { overflow-x: auto; position: relative; }
        .pnl-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.85rem; }
        .pnl-cell { padding: 14px 16px; white-space: nowrap; border-bottom: 1px solid #1E1E1E; color: #A1A1AA; text-align: right; }
        .pnl-cell-head { font-weight: 600; background-color: #050505; color: #6EE7B7; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.7rem; position: sticky; top: 0; z-index: 10; text-align: center; border-bottom: 1px solid #333; }
        .pnl-col-sticky { position: sticky; left: 0; background-color: #050505; z-index: 20; border-right: 1px solid #1E1E1E; text-align: left; min-width: 140px; }
        .pnl-col-sticky.pnl-cell-head { z-index: 30; } 
        .pnl-row-group-header { background-color: #121212; font-weight: 700; color: #FFFFFF; }
        .pnl-row-total { background-color: #0f172a; font-weight: 700; color: #34D399; }
        .pnl-row-net { background-color: #121212; font-weight: 800; color: #10B981; border-top: 1px solid #333; }
        .pnl-row-available { background-color: #121212; font-weight: 800; color: #3B82F6; border-top: 1px solid #333; }

        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        ::-webkit-calendar-picker-indicator { filter: invert(1); }
    </style>
</head>
<body class="bg-app-bg text-white overflow-hidden h-full">
    <div id="root" class="h-full"></div>

    <script type="module">
        import React, { useState, useEffect, useMemo, Component } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Wallet, TrendingUp, TrendingDown, Plus, Settings, 
            Calendar, DollarSign, RefreshCw, X, Save, ArrowRightLeft,
            LogOut, ChevronDown, Filter, Home, History, PieChart, Trash2, List, FileSpreadsheet,
            Users, User, Check, Repeat, Pencil, Loader2, ArrowUpRight, ArrowDownLeft, ChevronLeft, ChevronRight, PiggyBank, Mail, Lock, Search, AlertCircle, ShieldCheck, Bug, Database, AlertTriangle
        } from 'lucide-react';

        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            signInWithPopup, 
            signInAnonymously, 
            onAuthStateChanged, 
            signInWithCustomToken, 
            GoogleAuthProvider, 
            signOut,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, initializeFirestore, memoryLocalCache, collection, doc, setDoc, onSnapshot, query, orderBy, limit, addDoc, deleteDoc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return React.createElement('div', { className: "h-screen flex flex-col items-center justify-center p-6 text-center" },
                        React.createElement(Bug, { size: 48, className: "text-red-500 mb-4" }),
                        React.createElement('h2', { className: "text-2xl font-bold" }, "Algo salió mal"),
                        React.createElement('p', { className: "text-gray-400 my-4" }, this.state.error?.message),
                        React.createElement('button', { onClick: () => window.location.reload(), className: "bg-white text-black px-6 py-2 rounded-xl font-bold" }, "Recargar")
                    );
                }
                return this.props.children;
            }
        }

        // --- FIREBASE SETUP ---
        // Usamos TU configuración exacta
        const firebaseConfig = {
            apiKey: "AIzaSyCAd_vju_x9wuhGtZJvvoWpt9JbRUwB63k",
            authDomain: "sencillo-app-40a36.firebaseapp.com",
            databaseURL: "https://sencillo-app-40a36-default-rtdb.firebaseio.com",
            projectId: "sencillo-app-40a36",
            storageBucket: "sencillo-app-40a36.firebasestorage.app",
            messagingSenderId: "27193285455",
            appId: "1:27193285455:web:6cb0f8ac14f0e36fb0433a"
        };
        
        const rootCollection = 'projects';
        const appIdDoc = 'sencillo-app-40a36';

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            // IMPORTANTE: Usamos memoria caché para evitar errores en entornos restrictivos
            db = initializeFirestore(app, { localCache: memoryLocalCache() });
            console.log("Firebase initialized correctly with memory cache");
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }

        // --- CONSTANTS ---
        const DEFAULT_PNL = {
            ingresos: ["Sueldo", "Honorarios", "Ventas"],
            gastos_fijos: ["Alquiler", "Internet", "Condominio", "Colegio", "Suscripciones"],
            gastos_variables: ["Mercado", "Salidas", "Salud", "Transporte", "Gustos"],
            ahorro: ["Ahorro General"]
        };

        const SEGMENTS = {
            ingresos: { label: "Ingresos", color: "text-emerald-400", bg: "bg-emerald-400/10", type: "income" },
            ahorro: { label: "Ahorro", color: "text-blue-400", bg: "bg-blue-400/10", type: "expense" },
            gastos_fijos: { label: "Gastos Fijos", color: "text-orange-400", bg: "bg-orange-400/10", type: "expense" },
            gastos_variables: { label: "Gastos Variables", color: "text-rose-400", bg: "bg-rose-400/10", type: "expense" }
        };
        
        const RECURRENCE_OPTIONS = {
            none: "No repetir",
            weekly: "Semanalmente",
            monthly: "Mensualmente",
            yearly: "Anualmente"
        };

        // --- HELPERS ---
        const getRatesFromAPI = async () => {
            try {
                const [bcvRes, parallelRes] = await Promise.all([
                    fetch('https://ve.dolarapi.com/v1/dolares/oficial').catch(() => null),
                    fetch('https://ve.dolarapi.com/v1/dolares/paralelo').catch(() => null)
                ]);
                const newRates = {};
                if (bcvRes?.ok) { const d = await bcvRes.json(); if (d.promedio) newRates.bcv = parseFloat(d.promedio); }
                if (parallelRes?.ok) { const d = await parallelRes.json(); if (d.promedio) newRates.parallel = parseFloat(d.promedio); }
                return newRates;
            } catch (e) { console.error(e); return null; }
        };
        
        const getLocalDateString = (d = new Date()) => {
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- COMPONENTS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', type="button", disabled = false }) => {
            const variants = {
                primary: "bg-card-gradient text-white shadow-lg shadow-emerald-500/20 font-bold border border-white/10", 
                secondary: "bg-dark-highlight text-white border border-white/10 hover:bg-white/10",
                danger: "bg-red-500/10 text-red-500 hover:bg-red-500/20 border border-red-500/20",
            };
            return React.createElement('button', { 
                onClick, type, disabled,
                className: `px-6 py-4 rounded-2xl font-semibold text-sm tracking-wide transition-all active:scale-[0.98] flex items-center justify-center gap-2 w-full ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`
            }, children);
        };

        // --- SCREENS ---
        const LoginScreen = () => {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true); setErrorMsg(null);
                try {
                    if (isSignUp) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    setLoading(false);
                    if (error.code.includes('auth/invalid-email')) setErrorMsg("Email inválido.");
                    else if (error.code.includes('auth/wrong-password')) setErrorMsg("Contraseña incorrecta.");
                    else if (error.code.includes('auth/user-not-found')) setErrorMsg("Usuario no encontrado.");
                    else setErrorMsg(error.message);
                }
            };

            const handleGoogleLogin = async () => {
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (error) {
                    setErrorMsg("Google Auth bloqueado en este entorno. Usa Email/Password.");
                }
            };

            return React.createElement('div', { className: "h-full flex flex-col items-center justify-center p-6 bg-app-bg text-white" },
                React.createElement('div', { className: "w-full max-w-sm" },
                    React.createElement('div', { className: "text-center mb-8" },
                        React.createElement('div', { className: "w-24 h-24 bg-card-gradient rounded-3xl rotate-3 flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-emerald-500/20 text-white" }, React.createElement(Wallet, { size: 48 })),
                        React.createElement('h1', { className: "text-4xl font-black mb-2 tracking-tight" }, "Sencillo"),
                        React.createElement('p', { className: "text-gray-400 text-lg font-light" }, "Tus cuentas claras")
                    ),
                    errorMsg && React.createElement('div', { className: "mb-6 p-4 bg-red-500/10 border border-red-500/20 rounded-2xl text-red-400 text-sm flex items-center gap-2" }, React.createElement(AlertCircle, { size: 16 }), errorMsg),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-4" },
                        React.createElement('div', { className: "space-y-1" },
                            React.createElement('label', { className: "text-xs font-bold text-gray-500 ml-1 uppercase" }, "Email"),
                            React.createElement('div', { className: "relative" },
                                React.createElement('span', { className: "absolute left-4 top-3.5 text-gray-500" }, React.createElement(Mail, { size: 18 })),
                                React.createElement('input', { type: "email", value: email, onChange: (e) => setEmail(e.target.value), className: "w-full pl-11 pr-4 py-3 bg-dark-surface border border-white/10 rounded-xl text-white focus:outline-none focus:border-brand placeholder-gray-700", placeholder: "hola@ejemplo.com" })
                            )
                        ),
                        React.createElement('div', { className: "space-y-1" },
                            React.createElement('label', { className: "text-xs font-bold text-gray-500 ml-1 uppercase" }, "Contraseña"),
                            React.createElement('div', { className: "relative" },
                                React.createElement('span', { className: "absolute left-4 top-3.5 text-gray-500" }, React.createElement(Lock, { size: 18 })),
                                React.createElement('input', { type: "password", value: password, onChange: (e) => setPassword(e.target.value), className: "w-full pl-11 pr-4 py-3 bg-dark-surface border border-white/10 rounded-xl text-white focus:outline-none focus:border-brand placeholder-gray-700", placeholder: "••••••••" })
                            )
                        ),
                        React.createElement(Button, { type: "submit", disabled: loading, className: "mt-6" }, loading ? React.createElement(Loader2, { className: "animate-spin" }) : (isSignUp ? "Registrarse" : "Entrar")),
                        React.createElement('div', { className: "mt-4 text-center" },
                            React.createElement('button', { type: "button", onClick: handleGoogleLogin, className: "text-sm text-brand hover:underline" }, "O intenta con Google")
                        ),
                        React.createElement('div', { className: "mt-8 text-center" },
                            React.createElement('button', { type: "button", onClick: () => { setIsSignUp(!isSignUp); setErrorMsg(null); }, className: "text-sm text-gray-400 hover:text-brand" }, isSignUp ? "¿Ya tienes cuenta? Inicia sesión" : "¿No tienes cuenta? Regístrate")
                        )
                    )
                )
            );
        };

        const TransactionModal = ({ onClose, rates, userId, pnlStructure, initialData }) => {
            const isEditing = !!initialData;
            const [segment, setSegment] = useState(initialData?.segment || 'gastos_variables'); 
            const [amount, setAmount] = useState(initialData ? initialData.amount.toString() : '');
            const [currency, setCurrency] = useState(initialData?.currency || 'VES');
            const [category, setCategory] = useState(initialData?.category || '');
            const [description, setDescription] = useState(initialData?.description || '');
            const [rateType, setRateType] = useState(initialData ? 'manual' : 'bcv');
            const [customRate, setCustomRate] = useState(initialData ? initialData.originalRate : (rates.bcv || 0));
            const [recurrence, setRecurrence] = useState('none');
            const [date, setDate] = useState(() => {
                if (initialData && initialData.date) return initialData.date.split('T')[0];
                return getLocalDateString();
            });
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                const concepts = (pnlStructure && pnlStructure[segment]) || [];
                if ((!category || !concepts.includes(category)) && concepts.length > 0 && !isEditing) setCategory(concepts[0]);
            }, [segment, pnlStructure]);

            const calculatedUSD = useMemo(() => {
                if (!amount) return 0;
                if (currency === 'USD') return parseFloat(amount);
                let rate = 1;
                if (rateType === 'bcv') rate = rates.bcv;
                else if (rateType === 'parallel') rate = rates.parallel;
                else rate = customRate;
                if (!rate || rate === 0) return 0;
                return parseFloat(amount) / rate;
            }, [amount, currency, rateType, customRate, rates]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!amount || !category) return;
                setIsSaving(true);
                const finalRate = currency === 'USD' ? 1 : (rateType === 'bcv' ? rates.bcv : (rateType === 'parallel' ? rates.parallel : customRate));
                const type = SEGMENTS[segment].type;
                const finalDate = new Date(date + "T12:00:00").toISOString();
                const transactionData = { type, segment, amount: parseFloat(amount), currency, originalRate: parseFloat(finalRate), amountUSD: calculatedUSD, category, description, date: finalDate, profileId: 'personal' };

                try {
                    // ESTRUCTURA IMPORTANTE: projects/ID/users/UID/transactions
                    if (isEditing) {
                        await setDoc(doc(db, rootCollection, appIdDoc, 'users', userId, 'transactions', initialData.id), transactionData, { merge: true });
                    } else {
                        await addDoc(collection(db, rootCollection, appIdDoc, 'users', userId, 'transactions'), transactionData);
                        if (recurrence !== 'none') {
                            await addDoc(collection(db, rootCollection, appIdDoc, 'users', userId, 'recurring'), { ...transactionData, frequency: recurrence, startDate: finalDate });
                        }
                    }
                    onClose();
                } catch (error) {
                    console.error("Save Error:", error);
                    alert("¡Error Guardando! Revisa las Reglas de Firebase.\n\n" + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            const handleDelete = async () => {
                if (confirm("¿Eliminar?")) {
                    setIsSaving(true);
                    try {
                        await deleteDoc(doc(db, rootCollection, appIdDoc, 'users', userId, 'transactions', initialData.id));
                        onClose();
                    } catch (error) { alert(error.message); } finally { setIsSaving(false); }
                }
            };
            
            return React.createElement('div', { className: "fixed inset-0 bg-black/90 backdrop-blur-md z-50 flex items-end sm:items-center justify-center animate-fade-in" },
                React.createElement('div', { className: "bg-dark-base w-full max-w-md p-6 rounded-t-[2.5rem] sm:rounded-[2.5rem] max-h-[85vh] overflow-y-auto border border-white/10 shadow-2xl animate-slide-up" },
                    React.createElement('div', { className: "flex justify-between items-center mb-6" }, 
                        React.createElement('h2', { className: "text-2xl font-bold text-white tracking-tight" }, isEditing ? "Editar" : "Nuevo"), 
                        React.createElement('button', { onClick: onClose, className: "p-2 bg-dark-highlight rounded-full" }, React.createElement(X, { size: 24 }))
                    ),
                    React.createElement('div', { className: "flex gap-2 overflow-x-auto pb-4 mb-4 scrollbar-hide" }, 
                        Object.keys(SEGMENTS).map(key => 
                            React.createElement('button', { key: key, onClick: () => setSegment(key), className: `px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${segment === key ? `${SEGMENTS[key].bg} ${SEGMENTS[key].color} border-current` : 'bg-dark-highlight text-gray-500 border-transparent'}` }, SEGMENTS[key].label)
                        )
                    ),
                    React.createElement('form', { onSubmit: handleSubmit, className: "space-y-6" },
                        React.createElement('div', { className: "flex gap-3" },
                            React.createElement('div', { className: "relative flex-1" },
                                React.createElement('span', { className: "absolute left-5 top-5 text-gray-500 font-bold" }, currency === 'USD' ? '$' : 'Bs'),
                                React.createElement('input', { type: "number", step: "0.01", value: amount, onChange: e => setAmount(e.target.value), className: "w-full pl-12 pr-4 py-4 bg-dark-highlight rounded-2xl text-2xl font-bold text-white focus:outline-none focus:ring-2 focus:ring-brand" })
                            ),
                            React.createElement('select', { value: currency, onChange: e => setCurrency(e.target.value), className: "bg-dark-surface text-white font-bold rounded-2xl px-4 focus:outline-none border border-white/10" }, React.createElement('option', { value: "VES" }, "Bs"), React.createElement('option', { value: "USD" }, "USD"))
                        ),
                        React.createElement('div', { className: "grid grid-cols-12 gap-3" },
                            React.createElement('div', { className: "col-span-5" },
                                React.createElement('label', { className: "text-[10px] font-bold text-gray-500 uppercase ml-1 block mb-1" }, "Fecha"),
                                React.createElement('input', { type: "date", value: date, onChange: e => setDate(e.target.value), className: "w-full p-3 bg-dark-highlight rounded-xl text-white outline-none focus:ring-2 focus:ring-brand font-medium text-sm" })
                            ),
                            React.createElement('div', { className: "col-span-7" },
                                React.createElement('label', { className: "text-[10px] font-bold text-gray-500 uppercase ml-1 block mb-1" }, "Concepto"),
                                React.createElement('select', { value: category, onChange: e => setCategory(e.target.value), className: "w-full p-3 bg-dark-highlight text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-brand font-medium text-sm" }, (pnlStructure && pnlStructure[segment] ? pnlStructure[segment] : []).map(c => React.createElement('option', { key: c, value: c }, c)))
                            )
                        ),
                        currency === 'VES' && React.createElement('div', { className: "bg-dark-surface p-4 rounded-2xl border border-white/10" },
                            React.createElement('div', { className: "grid grid-cols-3 gap-2" },
                                React.createElement('button', { type: "button", onClick: () => setRateType('bcv'), className: `p-2 rounded-xl text-[10px] font-bold border ${rateType === 'bcv' ? 'bg-brand text-black border-brand' : 'bg-transparent text-gray-500 border-gray-700'}` }, "BCV", React.createElement('br'), rates.bcv),
                                React.createElement('button', { type: "button", onClick: () => setRateType('parallel'), className: `p-2 rounded-xl text-[10px] font-bold border ${rateType === 'parallel' ? 'bg-brand text-black border-brand' : 'bg-transparent text-gray-500 border-gray-700'}` }, "Paralelo", React.createElement('br'), rates.parallel),
                                React.createElement('button', { type: "button", onClick: () => setRateType('manual'), className: `p-2 rounded-xl text-[10px] font-bold border ${rateType === 'manual' ? 'bg-brand text-black border-brand' : 'bg-transparent text-gray-500 border-gray-700'}` }, "Manual")
                            ),
                            rateType === 'manual' && React.createElement('input', { type: "number", value: customRate, onChange: e => setCustomRate(e.target.value), className: "w-full mt-3 p-3 rounded-xl bg-dark-base border border-gray-700 text-center font-bold text-brand-light", placeholder: "Tasa personalizada" })
                        ),
                        React.createElement('div', { className: "space-y-1" }, 
                            React.createElement('label', { className: "text-[10px] font-bold text-gray-500 uppercase ml-1" }, "Nota"), 
                            React.createElement('input', { type: "text", value: description, onChange: e => setDescription(e.target.value), className: "w-full p-3 bg-dark-highlight text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-brand font-medium text-sm", placeholder: "Ej. Panadería" })
                        ),
                        React.createElement('div', { className: "flex gap-3 mt-6 pb-6" }, 
                            isEditing && React.createElement('button', { type: "button", onClick: handleDelete, disabled: isSaving, className: "p-4 rounded-2xl bg-red-500/10 text-red-500 border border-red-500/20" }, React.createElement(Trash2, { size: 24 })),
                            React.createElement(Button, { type: "submit", className: "flex-1", disabled: isSaving }, isSaving ? "Guardando..." : (isEditing ? "Actualizar" : "Guardar"))
                        )
                    )
                )
            );
        };

        const HomeView = ({ rates, transactions, user, onLogout, onOpenAdd, onEditTransaction }) => {
            const balance = transactions.reduce((acc, curr) => curr.type === 'income' ? acc + (curr.amountUSD || 0) : acc - (curr.amountUSD || 0), 0);
            return React.createElement('div', { className: "px-5 pb-32 space-y-8 animate-fade-in", style: { paddingTop: "calc(env(safe-area-inset-top) + 24px)" } },
                React.createElement('header', { className: "flex justify-between items-center pt-2" }, 
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('h1', { className: "text-3xl font-black text-white tracking-tight" }, "Sencillo"),
                        React.createElement('div', { className: "bg-dark-surface border border-white/10 px-3 py-1.5 rounded-full flex items-center gap-2" },
                            React.createElement('span', { className: "text-xs font-bold text-brand-light" }, `BCV ${rates.bcv || 0}`)
                        )
                    ),
                    React.createElement('button', { onClick: onLogout, className: "w-10 h-10 bg-dark-card text-gray-400 rounded-full flex items-center justify-center hover:text-white border border-white/10" }, React.createElement(LogOut, { size: 18 }))
                ),
                React.createElement('div', { className: "bg-card-gradient text-white p-8 rounded-[2.5rem] shadow-2xl relative overflow-hidden group" },
                    React.createElement('div', { className: "absolute -right-20 -top-20 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:scale-110 transition-transform duration-1000" }),
                    React.createElement('p', { className: "text-white/80 text-xs font-bold uppercase tracking-widest mb-2" }, "Balance Disponible"),
                    React.createElement('h2', { className: "text-5xl font-black mb-8 tracking-tight text-white" }, `$${balance.toFixed(2)}`),
                    React.createElement('button', { onClick: onOpenAdd, className: "w-full bg-white/90 text-emerald-900 hover:bg-white py-4 rounded-2xl text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-lg backdrop-blur-md" }, React.createElement(Plus, { size: 20 }), "Registrar Movimiento")
                ),
                React.createElement('div', { className: "space-y-3" },
                    React.createElement('h3', { className: "text-gray-400 text-sm font-bold uppercase tracking-wider ml-1" }, "Recientes"),
                    transactions.slice(0, 5).map(t => React.createElement('div', { key: t.id, onClick: () => onEditTransaction(t), className: "glass-panel p-4 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-white/5 active:scale-[0.98] transition-all" }, 
                        React.createElement('div', { className: "flex flex-col" }, 
                            React.createElement('span', { className: "font-bold text-white text-base" }, t.category), 
                            React.createElement('span', { className: "text-xs text-gray-400 font-medium" }, t.description || new Date(t.date).toLocaleDateString())
                        ), 
                        React.createElement('div', { className: "text-right" }, 
                            React.createElement('span', { className: `block font-bold text-lg ${t.type === 'income' ? 'text-emerald-400' : 'text-white'}` }, `${t.type === 'income' ? '+' : '-'}${(t.amountUSD || 0).toFixed(2)}`), 
                            React.createElement('span', { className: "text-xs text-gray-500 font-mono" }, t.currency === 'USD' ? 'USD' : `Bs ${t.amount}`)
                        )
                    ))
                )
            );
        };

        const ConfigView = ({ pnlData, onUpdatePnl, userId }) => {
            const [localPnl, setLocalPnl] = useState(pnlData);
            const [newConcept, setNewConcept] = useState("");
            const [activeSegment, setActiveSegment] = useState("ingresos"); 
            const [testStatus, setTestStatus] = useState(null);

            const handleAdd = () => {
                if (!newConcept.trim()) return;
                const updatedList = [...(localPnl[activeSegment] || []), newConcept.trim()];
                const newPnl = { ...localPnl, [activeSegment]: updatedList };
                setLocalPnl(newPnl);
                onUpdatePnl(newPnl); // Guardado automático
                setNewConcept("");
            };

            const runConnectionTest = async () => {
                setTestStatus("Probando...");
                try {
                    // Esta prueba intenta escribir exactamente en la ruta que usas
                    const testRef = doc(db, rootCollection, appIdDoc, 'users', userId, 'system', 'connection_test');
                    await setDoc(testRef, { last_check: new Date().toISOString(), status: "ok" });
                    setTestStatus("✅ Conexión Exitosa");
                } catch (e) {
                    console.error(e);
                    if (e.code === 'permission-denied') setTestStatus("❌ Error de Permisos (Revisa Reglas)");
                    else setTestStatus("❌ Error: " + e.code);
                }
            };

            return React.createElement('div', { className: "h-full flex flex-col pt-[env(safe-area-inset-top)] bg-app-bg" },
                React.createElement('div', { className: "p-6" }, React.createElement('h2', { className: "text-3xl font-bold text-white tracking-tight" }, "Configuración")),
                React.createElement('div', { className: "px-6 pb-32 space-y-6" },
                     React.createElement('div', { className: "bg-gray-900/50 p-4 rounded-2xl border border-white/5" },
                        React.createElement('button', { onClick: runConnectionTest, className: "w-full py-3 bg-brand/20 text-brand border border-brand/30 rounded-xl font-bold hover:bg-brand/30 transition-colors flex items-center justify-center gap-2" }, React.createElement(ShieldCheck, { size: 16 }), "PROBAR CONEXIÓN DB"),
                        testStatus && React.createElement('p', { className: `text-center font-bold mt-2 ${testStatus.includes('✅') ? 'text-emerald-400' : 'text-red-400'}` }, testStatus)
                    ),
                    React.createElement('div', { className: "flex gap-3 overflow-x-auto pb-2 scrollbar-hide" },
                        ["ingresos", "ahorro", "gastos_fijos", "gastos_variables"].map(seg => 
                            React.createElement('button', { key: seg, onClick: () => setActiveSegment(seg), className: `px-5 py-3 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeSegment === seg ? 'bg-brand text-black' : 'bg-dark-surface text-gray-400 border border-white/10'}` }, SEGMENTS[seg].label)
                        )
                    ),
                    React.createElement('div', { className: "flex gap-2" },
                        React.createElement('input', { value: newConcept, onChange: (e) => setNewConcept(e.target.value), placeholder: "Nuevo concepto...", className: "flex-1 p-4 rounded-2xl bg-dark-base border border-white/10 text-white focus:outline-none focus:border-brand" }),
                        React.createElement('button', { onClick: handleAdd, className: "bg-white text-black p-4 rounded-2xl" }, React.createElement(Plus, { size: 20 }))
                    ),
                    (localPnl[activeSegment] || []).map((concept, idx) => 
                        React.createElement('div', { key: idx, className: "p-4 bg-dark-card rounded-2xl border border-gray-800 text-gray-200" }, concept)
                    )
                )
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [rates, setRates] = useState({ bcv: 0, parallel: 0 });
            const [transactions, setTransactions] = useState([]);
            const [pnlStructure, setPnlStructure] = useState(DEFAULT_PNL);
            const [showModal, setShowModal] = useState(false);
            const [editingTx, setEditingTx] = useState(null);
            const [tab, setTab] = useState('home');
            const [dbError, setDbError] = useState(null);

            useEffect(() => onAuthStateChanged(auth, setUser), []);

            useEffect(() => {
                if (!user || !db) return;
                
                // Monitor DB Permissions
                const errorHandler = (err) => {
                    console.error("Firestore Listen Error:", err);
                    if (err.code === 'permission-denied') setDbError("Permisos denegados. Revisa las reglas en Firebase Console.");
                };

                const ratesRef = doc(db, rootCollection, appIdDoc, 'users', user.uid, 'settings', 'rates');
                const pnlRef = doc(db, rootCollection, appIdDoc, 'users', user.uid, 'settings', 'pnl');
                const transQ = query(collection(db, rootCollection, appIdDoc, 'users', user.uid, 'transactions'));

                const unsub1 = onSnapshot(ratesRef, (d) => { if(d.exists()) setRates(d.data()); else getRatesFromAPI().then(r => r && setRates(r)); }, errorHandler);
                const unsub2 = onSnapshot(pnlRef, (d) => { if(d.exists()) setPnlStructure(d.data()); }, errorHandler);
                const unsub3 = onSnapshot(transQ, (s) => setTransactions(s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(b.date) - new Date(a.date))), errorHandler);

                return () => { unsub1(); unsub2(); unsub3(); };
            }, [user]);

            const updatePnl = async (newPnl) => {
                await setDoc(doc(db, rootCollection, appIdDoc, 'users', user.uid, 'settings', 'pnl'), newPnl);
            };

            if (!user) return React.createElement(LoginScreen);

            return React.createElement(ErrorBoundary, null,
                React.createElement('div', { className: "h-screen w-full bg-app-bg flex flex-col text-white" },
                    dbError && React.createElement('div', { className: "bg-red-600 text-white text-xs font-bold text-center p-2" }, dbError),
                    React.createElement('div', { className: "flex-1 overflow-y-auto no-scrollbar" },
                        tab === 'home' ? React.createElement(HomeView, { rates, transactions, user, onLogout: () => signOut(auth), onOpenAdd: () => { setEditingTx(null); setShowModal(true); }, onEditTransaction: (t) => { setEditingTx(t); setShowModal(true); } }) :
                        tab === 'config' ? React.createElement(ConfigView, { pnlData: pnlStructure, onUpdatePnl: updatePnl, userId: user.uid }) : null
                    ),
                    React.createElement('nav', { className: "bg-dark-surface/90 backdrop-blur-xl border-t border-white/5 pb-safe pt-4 px-2 flex justify-around items-center z-30 safe-bottom fixed bottom-0 w-full" },
                        React.createElement('button', { onClick: () => setTab('home'), className: `p-4 rounded-2xl ${tab === 'home' ? 'text-brand bg-white/5' : 'text-gray-500'}` }, React.createElement(Home, { size: 28 })),
                        React.createElement('button', { onClick: () => { setEditingTx(null); setShowModal(true); }, className: "bg-brand text-black p-4 rounded-full -mt-8 shadow-lg shadow-brand/40 border-4 border-dark-base" }, React.createElement(Plus, { size: 28 })),
                        React.createElement('button', { onClick: () => setTab('config'), className: `p-4 rounded-2xl ${tab === 'config' ? 'text-brand bg-white/5' : 'text-gray-500'}` }, React.createElement(Settings, { size: 28 }))
                    ),
                    showModal && React.createElement(TransactionModal, { onClose: () => setShowModal(false), rates, userId: user.uid, pnlStructure, initialData: editingTx })
                )
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
